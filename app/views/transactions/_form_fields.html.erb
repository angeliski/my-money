<%= form_with(model: transaction, data: { controller: "transaction-form" }, class: "space-y-4") do |f| %>
  <% if transaction.errors.any? %>
    <div class="bg-red-900/30 border border-red-700 text-red-300 px-4 py-3 rounded-lg">
      <ul class="text-sm">
        <% transaction.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Campo hidden para tipo -->
  <%= f.hidden_field :transaction_type, value: transaction_type %>

  <!-- Campo de Valor com Money Input Controller - Posicionado no topo como um header -->
  <div data-controller="money-input" class="-mx-6 -mt-6 px-6 pt-6 pb-8 mb-6 <%= header_color || 'bg-gradient-to-b from-[#10B981] to-[#059669]' %>">
    <label class="text-sm text-white/80">Valor da <%= transaction_type == 'transfer' ? 'transferência' : (transaction_type == 'income' ? 'receita' : 'despesa') %></label>
    <div class="text-4xl font-bold text-white mt-2 flex items-center">
      <span>R$</span>
      <input type="text"
             name="transaction[amount_display]"
             data-money-input-target="input"
             data-action="input->money-input#format"
             placeholder="0,00"
             class="bg-transparent border-none outline-none w-48 text-white placeholder-white/50 ml-2"
             autocomplete="off" />
      <%= f.hidden_field :amount_cents, data: { money_input_target: "hiddenInput" }, value: transaction.amount_cents %>
    </div>
  </div>

  <% if toggle_label.present? %>
    <!-- Toggle Recebido/Pago -->
    <div class="flex items-center justify-between py-3 border-b border-[#3D3D3D]">
      <span class="text-[#E5E5E5] font-medium"><%= toggle_label %></span>
      <label class="relative inline-flex items-center cursor-pointer">
        <%= f.check_box :manually_effectuated, class: "sr-only peer", checked: !transaction.pending_by_date? %>
        <div class="w-11 h-6 bg-[#4D4D4D] peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#10B981]"></div>
      </label>
    </div>
  <% end %>

  <!-- Data -->
  <div class="flex items-center gap-3 py-3 border-b border-[#3D3D3D]">
    <svg class="w-5 h-5 text-[#E5E5E5]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
    </svg>
    <%= f.date_field :transaction_date,
        value: transaction.transaction_date || Date.today,
        class: "flex-1 bg-transparent text-[#E5E5E5] outline-none" %>
  </div>

  <!-- Descrição -->
  <div class="flex items-center gap-3 py-3 border-b border-[#3D3D3D]">
    <svg class="w-5 h-5 text-[#E5E5E5]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
    </svg>
    <%= f.text_field :description,
        placeholder: "Descrição",
        class: "flex-1 bg-transparent text-[#E5E5E5] placeholder-[#A3A3A3] outline-none" %>
  </div>

  <!-- Categoria -->
  <div class="flex items-center gap-3 py-3 border-b border-[#3D3D3D]">
    <svg class="w-5 h-5 text-[#E5E5E5]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
    </svg>
    <div class="flex-1">
      <label class="text-xs text-[#E5E5E5] block mb-1">Categoria</label>
      <%
        category_type = transaction_type == 'income' ? 'income' : 'expense'
        categories = Category.where(category_type: category_type).order(:name)
        category_options = categories.map { |c| ["#{c.icon} #{c.name}", c.id] }
      %>
      <%= f.select :category_id,
          options_for_select(category_options, transaction.category_id),
          { prompt: 'Selecionar categoria' },
          { class: "w-full bg-[#4D4D4D] text-[#E5E5E5] rounded-lg px-3 py-2 outline-none" } %>
    </div>
  </div>

  <!-- Conta (ou Contas para transferência) -->
  <% accounts = Account.all.order(:name) %>
  <% account_options = accounts.map { |a| [a.name, a.id] } %>

  <% if transaction_type == 'transfer' %>
    <!-- De conta -->
    <div class="flex items-center gap-3 py-3 border-b border-[#3D3D3D]">
      <svg class="w-5 h-5 text-[#E5E5E5]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
      </svg>
      <div class="flex-1">
        <label class="text-xs text-[#E5E5E5] block mb-1">De conta</label>
        <%= f.select :account_id,
            options_for_select(account_options, transaction.account_id),
            { prompt: 'Selecionar conta origem' },
            { class: "w-full bg-[#4D4D4D] text-[#E5E5E5] rounded-lg px-3 py-2 outline-none" } %>
      </div>
    </div>

    <!-- Separador -->
    <div class="flex items-center justify-center py-2">
      <div class="text-center">
        <svg class="w-6 h-6 text-[#E5E5E5] mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
        </svg>
        <span class="text-xs text-[#E5E5E5]">Transferir para</span>
      </div>
    </div>

    <!-- Para conta -->
    <div class="flex items-center gap-3 py-3 border-b border-[#3D3D3D]">
      <svg class="w-5 h-5 text-[#E5E5E5]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
      </svg>
      <div class="flex-1">
        <label class="text-xs text-[#E5E5E5] block mb-1">Para conta</label>
        <%= f.select :destination_account_id,
            options_for_select(account_options, transaction.destination_account_id),
            { prompt: 'Selecionar conta destino' },
            { class: "w-full bg-[#4D4D4D] text-[#E5E5E5] rounded-lg px-3 py-2 outline-none" } %>
      </div>
    </div>
  <% else %>
    <!-- Conta normal -->
    <div class="flex items-center gap-3 py-3 border-b border-[#3D3D3D]">
      <svg class="w-5 h-5 text-[#E5E5E5]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
      </svg>
      <div class="flex-1">
        <label class="text-xs text-[#E5E5E5] block mb-1">Conta</label>
        <%= f.select :account_id,
            options_for_select(account_options, transaction.account_id),
            { prompt: 'Selecionar conta' },
            { class: "w-full bg-[#4D4D4D] text-[#E5E5E5] rounded-lg px-3 py-2 outline-none" } %>
      </div>
    </div>
  <% end %>

  <!-- Observação -->
  <div class="flex items-start gap-3 py-3 border-b border-[#3D3D3D]">
    <svg class="w-5 h-5 text-[#E5E5E5] mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
    </svg>
    <%= f.text_area :notes,
        placeholder: "Observação (opcional)",
        rows: 2,
        class: "flex-1 bg-transparent text-[#E5E5E5] placeholder-[#A3A3A3] outline-none resize-none" %>
  </div>

  <!-- Toggle Recorrente -->
  <div class="flex items-center justify-between py-3 border-b border-[#3D3D3D]">
    <div class="flex items-center gap-3">
      <svg class="w-5 h-5 text-[#E5E5E5]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
      </svg>
      <span class="text-[#E5E5E5] font-medium">
        <%= transaction_type == 'transfer' ? 'Transferência recorrente' : (transaction_type == 'income' ? 'Receita recorrente' : 'Despesa recorrente') %>
      </span>
    </div>
    <label class="relative inline-flex items-center cursor-pointer">
      <%= f.check_box :is_template,
          class: "sr-only peer",
          data: { action: "change->transaction-form#toggleRecurring" } %>
      <div class="w-11 h-6 bg-[#4D4D4D] peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#7C3AED]"></div>
    </label>
  </div>

  <!-- Opções de recorrência (escondidas por padrão) -->
  <div data-transaction-form-target="recurringOptions" class="<%= transaction.is_template? ? '' : 'hidden' %> space-y-4 pt-2">
    <div class="text-sm text-[#E5E5E5] mb-2">Como sua transação se repete?</div>

    <div class="flex items-center gap-3">
      <span class="text-[#E5E5E5]">Quantidade:</span>
      <div class="flex items-center gap-2">
        <button type="button"
                data-action="click->transaction-form#decrementOccurrences"
                class="w-8 h-8 rounded-full bg-[#4D4D4D] text-white flex items-center justify-center hover:bg-[#5D5D5D]">
          -
        </button>
        <span class="w-12 text-center text-[#E5E5E5] font-semibold" data-transaction-form-target="occurrencesDisplay">2</span>
        <button type="button"
                data-action="click->transaction-form#incrementOccurrences"
                class="w-8 h-8 rounded-full bg-[#4D4D4D] text-white flex items-center justify-center hover:bg-[#5D5D5D]">
          +
        </button>
      </div>
      <%= f.hidden_field :occurrences, value: 2, data: { 'transaction-form-target': 'occurrencesInput' } %>
    </div>

    <div>
      <%= f.label :frequency, "Período", class: "text-sm text-[#E5E5E5] block mb-2" %>
      <%= f.select :frequency,
          options_for_select([
            ['Mensal', 'monthly'],
            ['Semanal', 'weekly'],
            ['Diário', 'daily'],
            ['Anual', 'annual']
          ], transaction.frequency),
          {},
          { class: "w-full bg-[#4D4D4D] text-[#E5E5E5] rounded-lg px-4 py-3 outline-none" } %>
    </div>
  </div>

  <!-- Botão de Confirmação (Fixo no bottom) -->
  <div class="fixed bottom-0 left-0 right-0 sm:relative p-6 bg-[#2D2D2D] sm:bg-transparent sm:p-0 sm:mt-6">
    <%= f.submit transaction.new_record? ? 'CRIAR' : 'SALVAR',
        class: "w-full sm:w-auto sm:min-w-[200px] #{transaction_type == 'income' ? 'bg-[#10B981] hover:bg-[#059669]' : (transaction_type == 'expense' ? 'bg-[#F87171] hover:bg-[#EF4444]' : 'bg-[#8B5CF6] hover:bg-[#7C3AED]')} text-white font-semibold py-4 rounded-full transition-colors shadow-lg" %>
  </div>
<% end %>
